@startuml
title Carrito ESP32 + HC-SR04 — Secuencia general
autonumber

participant User as "Cliente\n(Postman/Navegador)"
participant HTTP as "ESP32 WebServer\n(/status, /control)"
participant CTRL as "Control (loop)"
participant L298N as "Driver L298N\n(IN1..IN4)"
participant US as "HC-SR04"
participant MQTT as "Cliente MQTT"
participant Broker as "Broker MQTT"

' ================== BOOT / SETUP ==================
group BOOT / SETUP
  User -> HTTP : Reset / Power ON
  HTTP -> CTRL : setup()
  CTRL -> CTRL : pinMode motores (OUT)\nstopMotors()
  CTRL -> US : pinMode(TRIG=OUT),\npinMode(ECHO=IN); TRIG=LOW
  CTRL -> HTTP : WebServer: server.on(/status,/control)\nserver.begin()
  CTRL -> CTRL : connectWiFi(SSID,PASS)\n(wait hasta WL_CONNECTED)
  CTRL -> MQTT : setServer(MQTT_SERVER, PORT)
  CTRL -> MQTT : ensureMQTT()
  MQTT -> Broker : CONNECT(clientId)
  Broker --> MQTT : CONNACK
end

' ================== PETICIÓN /control ==================
group /control (mando de movimiento)
  User -> HTTP : GET /control?\ndirection=left&duration=600
  HTTP -> CTRL : parse(direction,duration)
  CTRL -> L298N : stopMotors()\n(freno + neutral)
  CTRL -> CTRL : moving=true;\nendTime = now + 600ms
  CTRL -> L298N : aplicar IN1..IN4 (LEFT)
  alt MQTT conectado
    CTRL -> MQTT : publish(MQTT_TOPIC_CMD,\n"Direccion:left,Duracion:600,...")
    MQTT -> Broker : PUBLISH
  else MQTT no conectado
    CTRL -> CTRL : (omitir publish)
  end
end

' ================== AUTO-STOP EN LOOP ==================
group Auto-stop por duración
  note over CTRL : loop() periódico
  CTRL -> CTRL : if (moving && millis() >= endTime)
  CTRL -> L298N : stopMotors()
  CTRL -> CTRL : moving = false
end

' ================== TELEMETRÍA PERIÓDICA ==================
loop cada 500 ms (PUBLISH_INTERVAL_MS)
  CTRL -> US : TRIG 10µs
  US --> CTRL : ECHO HIGH (duración µs)
  CTRL -> CTRL : cm = (dur * 0.0343) / 2\nclamp[min=5, max=300]
  alt MQTT conectado
    CTRL -> MQTT : publish(MQTT_TOPIC_DISTANCE,\n{"distance_cm":cm,"ts":now})
    MQTT -> Broker : PUBLISH
  else MQTT no conectado
    CTRL -> CTRL : (skip publish)
  end
end

' ================== END ==================
@enduml
